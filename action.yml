name: publish-pr-artifact
description: Compute artifact name, upload it, fetch artifact id and update PR body
inputs:
  github-token:
    required: true
  preview-number:
    required: true
    description: Preview number
  artifact-path:
    required: false
    default: out
  release-marker:
    required: false
    default: "ðŸŽ¯ PR Release ðŸŽ¯"
    description: Marker im PR-Body
runs:
  using: composite
  steps:
    - name: Compute artifact name
      id: compute-name
      uses: actions/github-script@v7
      with:
        github-token: ${{ inputs.github-token }}
        script: |
          const prNumber = context.payload.pull_request.number;
          const previewNumber = '${{ inputs.preview-number }}';
          const name = `PR-${prNumber}-Preview-${previewNumber}`;
          core.setOutput('artifact-name', name);
          console.log(`Artifact name: ${name}`);
    - name: Upload build output
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.compute-name.outputs.artifact-name }}
        path: ${{ inputs.artifact-path }}
    - name: Get artifact id
      id: get-id
      uses: actions/github-script@v7
      with:
        github-token: ${{ inputs.github-token }}
        script: |
          const { owner, repo } = context.repo;
          const run_id = context.runId;
          const targetName = '${{ steps.compute-name.outputs.artifact-name }}';
          async function findArtifact(retries = 5) {
            for (let i = 0; i < retries; i++) {
              const res = await github.rest.actions.listWorkflowRunArtifacts({ owner, repo, run_id, per_page: 100 });
              const artifact = res.data.artifacts.find(a => a.name === targetName);
              if (artifact) return artifact;
              await new Promise(r => setTimeout(r, 3000));
            }
            return null;
          }
          const artifact = await findArtifact();
          if (!artifact) {
            core.setFailed(`Artifact '${targetName}' not found.`);
          } else {
            core.setOutput('artifact-id', artifact.id.toString());
            console.log(`Found artifact ID: ${artifact.id}`);
          }
    - name: Update PR body
      if: ${{ success() }}
      uses: actions/github-script@v7
      with:
        github-token: ${{ inputs.github-token }}
        script: |
          const { owner, repo } = context.repo;
          const number = context.payload.pull_request.number;
          const runId = context.runId;
          const previewNumber = '${{ inputs.preview-number }}';
          const artifactId = '${{ steps.get-id.outputs.artifact-id }}';
          const artifactName = '${{ steps.compute-name.outputs.artifact-name }}';
          const releaseMarker = '${{ inputs.release-marker }}';

          let artifactLink = `https://github.com/${owner}/${repo}/actions/runs/${runId}`;
            if (artifactId) {
              artifactLink = `https://github.com/${owner}/${repo}/actions/runs/${runId}/artifacts/${artifactId}`;
            }

          const newPreviewLine = `ðŸ‘‰ [Preview ${previewNumber}](${artifactLink})`;

          const pr = await github.rest.pulls.get({ owner, repo, pull_number: number });
          let prBody = pr.data.body || '';

          const releaseMarkerIndex = prBody.indexOf(releaseMarker);

          if (releaseMarkerIndex !== -1) {
            const afterMarker = prBody.substring(releaseMarkerIndex);
            const previewPattern = /(?:~~)?.*(?:\[Preview (\d+)\]|Preview (\d+))/g;
            const matches = [...afterMarker.matchAll(previewPattern)];
            if (matches.length > 0) {
              const lastMatch = matches[matches.length - 1];
              const lastPreviewEndIndex = releaseMarkerIndex + lastMatch.index + lastMatch[0].length;
              prBody = prBody.substring(0, lastPreviewEndIndex) + '\n' + newPreviewLine + prBody.substring(lastPreviewEndIndex);
            } else {
              prBody = prBody.substring(0, releaseMarkerIndex + releaseMarker.length) + '\n' + newPreviewLine + prBody.substring(releaseMarkerIndex + releaseMarker.length);
            }
          } else {
            prBody += `\n\n---\n\n${releaseMarker}\n${newPreviewLine}`;
          }

          await github.rest.pulls.update({ owner, repo, pull_number: number, body: prBody });
          console.log('PR body updated with preview link.');